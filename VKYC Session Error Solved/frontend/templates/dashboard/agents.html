{% extends 'dashboard/base.html' %}

{% block title %}Agents - RegTech API{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
        <h1>Agents</h1>
    </div>
    <button class="btn btn-primary" onclick="showCreateAgentModal()">Create Agent</button>
</div>

<div id="errorMessage" style="display: none; padding: 15px; margin: 20px 0; background-color: #f8d7da; color: #721c24; border-radius: 4px;"></div>
<div id="successMessage" style="display: none; padding: 15px; margin: 20px 0; background-color: #d4edda; color: #155724; border-radius: 4px;"></div>

<table>
    <thead>
        <tr>
            <th>Employee ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Mobile</th>
            <th>Role</th>
            <th>Status</th>
            <th>Restrict V-KYC</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="agentsTable">
        <tr>
            <td colspan="9" style="text-align: center; padding: 20px;">Loading agents...</td>
        </tr>
    </tbody>
</table>

<!-- Create Agent Modal -->
<div id="createModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px; margin: 20px 0;">
        <h2>Create Agent</h2>
        <form id="createAgentForm" onsubmit="createAgent(event)">
            <div style="margin: 15px 0;">
                <label>Employee ID <span style="color: red;">*</span>:</label>
                <input type="text" id="employeeId" name="employee_id" required 
                       pattern="[A-Za-z0-9_-]+" 
                       title="Employee ID should contain only letters, numbers, hyphens, and underscores"
                       style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #666;">Alphanumeric, hyphens, and underscores only</small>
            </div>
            <div style="margin: 15px 0;">
                <label>First Name <span style="color: red;">*</span>:</label>
                <input type="text" id="firstName" name="first_name" required 
                       pattern="[A-Za-z\s]+" 
                       title="First name should contain only letters and spaces"
                       style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin: 15px 0;">
                <label>Last Name <span style="color: red;">*</span>:</label>
                <input type="text" id="lastName" name="last_name" required 
                       pattern="[A-Za-z\s]+" 
                       title="Last name should contain only letters and spaces"
                       style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin: 15px 0;">
                <label>Email <span style="color: red;">*</span>:</label>
                <input type="email" id="email" name="email" required 
                       style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <small id="emailError" style="color: red; display: none;"></small>
            </div>
            <div style="margin: 15px 0;">
                <label>Mobile Number <span style="color: red;">*</span>:</label>
                <input type="tel" id="mobile" name="mobile" required 
                       pattern="[0-9]{10}" 
                       title="Mobile number must be exactly 10 digits"
                       maxlength="10"
                       style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <small id="mobileError" style="color: red; display: none;"></small>
                <small style="color: #666;">10 digits only (e.g., 9876543210)</small>
            </div>
            <div style="margin: 15px 0;">
                <label>Role <span style="color: red;">*</span>:</label>
                <select id="role" name="role" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Select Role</option>
                    <option value="Agent">Agent</option>
                    <option value="QA">QA</option>
                    <option value="Lead">Lead</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeCreateModal()" style="background: #ccc;">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">Create Agent</button>
            </div>
        </form>
    </div>
</div>

<script>
// Load agents on page load
window.onload = function() {
    loadAgents();
};

function showCreateAgentModal() {
    document.getElementById('createModal').style.display = 'block';
    document.getElementById('createAgentForm').reset();
    document.getElementById('emailError').style.display = 'none';
    document.getElementById('mobileError').style.display = 'none';
    hideMessages();
}

function closeCreateModal() {
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('createAgentForm').reset();
    document.getElementById('emailError').style.display = 'none';
    document.getElementById('mobileError').style.display = 'none';
}

function hideMessages() {
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('successMessage').style.display = 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    document.getElementById('successMessage').style.display = 'none';
    setTimeout(() => {
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}

function showSuccess(message) {
    const successDiv = document.getElementById('successMessage');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    document.getElementById('errorMessage').style.display = 'none';
    setTimeout(() => {
        successDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}

// Email validation
function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Mobile validation
function validateMobile(mobile) {
    const mobileRegex = /^[0-9]{10}$/;
    return mobileRegex.test(mobile);
}

// Real-time validation
document.getElementById('email').addEventListener('blur', function() {
    const email = this.value.trim();
    const errorDiv = document.getElementById('emailError');
    if (email && !validateEmail(email)) {
        errorDiv.textContent = 'Please enter a valid email address';
        errorDiv.style.display = 'block';
        this.style.borderColor = 'red';
    } else {
        errorDiv.style.display = 'none';
        this.style.borderColor = '#ddd';
    }
});

document.getElementById('mobile').addEventListener('input', function() {
    // Remove non-numeric characters
    this.value = this.value.replace(/[^0-9]/g, '');
    
    const mobile = this.value;
    const errorDiv = document.getElementById('mobileError');
    if (mobile && !validateMobile(mobile)) {
        errorDiv.textContent = 'Mobile number must be exactly 10 digits';
        errorDiv.style.display = 'block';
        this.style.borderColor = 'red';
    } else {
        errorDiv.style.display = 'none';
        this.style.borderColor = '#ddd';
    }
});

async function createAgent(event) {
    event.preventDefault();
    hideMessages();
    
    const form = event.target;
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    
    // Get form values
    const employeeId = document.getElementById('employeeId').value.trim();
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const email = document.getElementById('email').value.trim();
    const mobile = document.getElementById('mobile').value.trim();
    const role = document.getElementById('role').value;
    
    // Validation
    if (!employeeId) {
        showError('Employee ID is required');
        return;
    }
    
    if (!firstName || !/^[A-Za-z\s]+$/.test(firstName)) {
        showError('First name is required and should contain only letters');
        return;
    }
    
    if (!lastName || !/^[A-Za-z\s]+$/.test(lastName)) {
        showError('Last name is required and should contain only letters');
        return;
    }
    
    if (!email || !validateEmail(email)) {
        showError('Please enter a valid email address');
        return;
    }
    
    if (!mobile || !validateMobile(mobile)) {
        showError('Mobile number must be exactly 10 digits');
        return;
    }
    
    if (!role) {
        showError('Please select a role');
        return;
    }
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    
    try {
        const response = await fetch('/api/agents/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                employee_id: employeeId,
                first_name: firstName,
                last_name: lastName,
                email: email,
                mobile: mobile,
                role: role
            })
        });
        
        const data = await response.json();
        
        if (response.ok && !data.error) {
            showSuccess('Agent created successfully!');
            closeCreateModal();
            loadAgents();
        } else {
            showError(data.error || data.detail || 'Failed to create agent. Please try again.');
        }
    } catch (error) {
        showError('Error creating agent: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

async function loadAgents() {
    const tableBody = document.getElementById('agentsTable');
    
    try {
        const response = await fetch('/api/agents');
        
        // Check if response is OK
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Check content type
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Expected JSON but got:', text.substring(0, 200));
            throw new Error('Server returned non-JSON response. Make sure the backend is running.');
        }
        
        const data = await response.json();
        
        if (data.error) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 20px; background-color: #fff3cd; color: #856404;">
                        ⚠️ ${data.error}
                    </td>
                </tr>
            `;
            showError(data.error);
            return;
        }
        
        if (!data || data.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px;">No agents found. Create your first agent!</td>
                </tr>
            `;
            return;
        }
        
        tableBody.innerHTML = data.map(agent => `
            <tr>
                <td>${agent.employee_id || '-'}</td>
                <td>${agent.first_name} ${agent.last_name}</td>
                <td>${agent.email}</td>
                <td>${agent.mobile || '-'}</td>
                <td>${agent.role}</td>
                <td>
                    <span style="padding: 4px 8px; border-radius: 4px; background: ${agent.is_active === 'active' ? '#d4edda' : '#f8d7da'}; color: ${agent.is_active === 'active' ? '#155724' : '#721c24'};">
                        ${agent.is_active === 'active' ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <span style="padding: 4px 8px; border-radius: 4px; background: ${agent.restrict_vkyc === 'yes' ? '#fff3cd' : '#d4edda'}; color: ${agent.restrict_vkyc === 'yes' ? '#856404' : '#155724'};">
                        ${agent.restrict_vkyc === 'yes' ? 'Yes' : 'No'}
                    </span>
                </td>
                <td>${new Date(agent.created_at).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm" onclick="viewAgent(${agent.id})" style="padding: 4px 8px; font-size: 12px;">View</button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading agents:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center; padding: 20px; background-color: #f8d7da; color: #721c24;">
                    ⚠️ Error loading agents: ${error.message}
                </td>
            </tr>
        `;
        showError('Failed to load agents: ' + error.message);
    }
}

function viewAgent(agentId) {
    // TODO: Implement view agent details
    alert('View agent details for ID: ' + agentId);
}
</script>
{% endblock %}
